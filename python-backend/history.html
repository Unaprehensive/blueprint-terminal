<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blueprint FX - Trading History & Analytics</title>
    <style>
        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #141824;
            --bg-panel: rgba(20, 24, 36, 0.95);
            --accent-primary: #00ffff;
            --accent-secondary: #ff00ff;
            --accent-tertiary: #8b5cf6;
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --border: rgba(139, 92, 246, 0.3);
            --shadow-glow: 0 0 20px rgba(0, 255, 255, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            position: relative;
        }

        /* Animated Background */
        .bg-animation {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
            opacity: 0.05;
            background: 
                radial-gradient(circle at 20% 50%, var(--accent-primary) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, var(--accent-secondary) 0%, transparent 50%);
            animation: bgPulse 10s ease-in-out infinite;
        }

        @keyframes bgPulse {
            0%, 100% { opacity: 0.05; }
            50% { opacity: 0.1; }
        }

        /* Header */
        .header {
            background: var(--bg-panel);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
        }

        .nav-btn {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .nav-btn:hover {
            background: var(--accent-tertiary);
            color: white;
            transform: translateY(-2px);
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        /* Date Filters */
        .filters-section {
            background: var(--bg-panel);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 20px;
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(180deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 2px;
        }

        .date-range {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .date-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .date-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .date-input {
            padding: 10px 15px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .date-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
        }

        .btn-load {
            padding: 12px 30px;
            background: linear-gradient(135deg, var(--accent-tertiary), var(--accent-primary));
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .btn-load:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 255, 255, 0.4);
        }

        /* Quick Period Buttons */
        .quick-periods {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .period-btn {
            padding: 8px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .period-btn:hover {
            background: var(--accent-tertiary);
            color: white;
            transform: translateY(-1px);
        }

        /* Statistics Cards */
        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-panel);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border-color: var(--accent-primary);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            animation: slideGradient 3s ease infinite;
        }

        @keyframes slideGradient {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--text-primary);
        }

        .stat-value.positive {
            color: var(--success);
        }

        .stat-value.negative {
            color: var(--danger);
        }

        .stat-change {
            font-size: 12px;
            margin-top: 5px;
            opacity: 0.8;
        }

        /* Profit Chart */
        .chart-section {
            background: var(--bg-panel);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }

        .chart-canvas {
            width: 100%;
            height: 300px;
        }

        /* Trades Table */
        .table-section {
            background: var(--bg-panel);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid var(--border);
        }

        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .search-box {
            position: relative;
            width: 300px;
        }

        .search-input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 8px;
            font-size: 14px;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .export-btn {
            padding: 10px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .export-btn:hover {
            background: var(--accent-tertiary);
            color: white;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .trades-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .trades-table thead {
            background: var(--bg-secondary);
        }

        .trades-table th {
            padding: 15px;
            text-align: left;
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 10;
        }

        .trades-table td {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 14px;
        }

        .trades-table tbody tr {
            transition: all 0.2s;
        }

        .trades-table tbody tr:hover {
            background: rgba(139, 92, 246, 0.1);
        }

        .trade-id {
            color: var(--accent-primary);
            font-weight: bold;
        }

        .symbol-badge {
            background: var(--bg-secondary);
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: bold;
            color: var(--accent-primary);
        }

        .trade-type {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .trade-type.buy {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }

        .trade-type.sell {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .exit-type {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .exit-type.tp {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .exit-type.sl {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .exit-type.manual {
            background: rgba(139, 92, 246, 0.15);
            color: var(--accent-tertiary);
            border: 1px solid var(--accent-tertiary);
        }

        /* Profit Colors */
        .profit-cell {
            font-weight: bold;
        }

        .profit-cell.positive {
            color: var(--success);
        }

        .profit-cell.negative {
            color: var(--danger);
        }

        /* Loading State */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 26, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 3px solid transparent;
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-tertiary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-primary);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .page-btn {
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 40px;
            text-align: center;
        }

        .page-btn:hover {
            background: var(--accent-tertiary);
            color: white;
            transform: translateY(-2px);
        }

        .page-btn.active {
            background: var(--accent-primary);
            color: var(--bg-primary);
            font-weight: bold;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Distribution Chart */
        .distribution-section {
            background: var(--bg-panel);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .pie-chart-container {
            position: relative;
            height: 250px;
        }

        .legend {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .legend-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .legend-value {
            font-weight: bold;
            color: var(--text-primary);
            margin-left: auto;
        }

        /* Animation for numbers */
        @keyframes countUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animated-number {
            animation: countUp 0.5s ease-out;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .stats-section {
                grid-template-columns: 1fr;
            }
            
            .date-range {
                flex-direction: column;
                gap: 10px;
            }
            
            .distribution-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>

    <!-- Header -->
    <header class="header">
        <div class="logo">BluePrint History</div>
        <div class="nav-buttons">
            <button class="nav-btn" onclick="window.location.href='/terminal'">Back to Terminal</button>
            <button class="nav-btn" onclick="refreshData()"> Refresh</button>
            <button class="nav-btn" onclick="exportToCSV()"> Export CSV</button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Date Filters -->
        <div class="filters-section">
            <div class="filters-header">
                <h2 class="section-title">Trade History Filter</h2>
            </div>
            
            <div class="date-range">
                <div class="date-input-group">
                    <span class="date-label">From:</span>
                    <input type="date" id="dateFrom" class="date-input">
                </div>
                <div class="date-input-group">
                    <span class="date-label">To:</span>
                    <input type="date" id="dateTo" class="date-input">
                </div>
                <button class="btn-load" onclick="loadHistory()">Load History</button>
            </div>
            
            <div class="quick-periods">
                <button class="period-btn" onclick="setPeriod('today')">Today</button>
                <button class="period-btn" onclick="setPeriod('yesterday')">Yesterday</button>
                <button class="period-btn" onclick="setPeriod('week')">This Week</button>
                <button class="period-btn" onclick="setPeriod('month')">This Month</button>
                <button class="period-btn" onclick="setPeriod('3months')">Last 3 Months</button>
                <button class="period-btn" onclick="setPeriod('year')">This Year</button>
                <button class="period-btn" onclick="setPeriod('all')">All Time</button>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-section">
            <div class="stat-card">
                <div class="stat-label">Total Trades</div>
                <div class="stat-value animated-number" id="totalTrades">0</div>
                <div class="stat-change positive"> All executed trades</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-label">Win Rate</div>
                <div class="stat-value animated-number" id="winRate">0%</div>
                <div class="stat-change" id="winRateTrend">-</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-label">Net Profit</div>
                <div class="stat-value animated-number" id="netProfit">$0.00</div>
                <div class="stat-change" id="profitTrend">-</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-label">Average Win</div>
                <div class="stat-value positive animated-number" id="avgWin">$0.00</div>
                <div class="stat-change">Per winning trade</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-label">Average Loss</div>
                <div class="stat-value negative animated-number" id="avgLoss">-$0.00</div>
                <div class="stat-change">Per losing trade</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-label">Profit Factor</div>
                <div class="stat-value animated-number" id="profitFactor">0.00</div>
                <div class="stat-change" id="profitFactorStatus">-</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-label">Best Trade</div>
                <div class="stat-value positive animated-number" id="bestTrade">$0.00</div>
                <div class="stat-change">Maximum profit</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-label">Worst Trade</div>
                <div class="stat-value negative animated-number" id="worstTrade">-$0.00</div>
                <div class="stat-change">Maximum loss</div>
            </div>
        </div>

        <!-- Profit Chart -->
        <div class="chart-section">
            <h2 class="section-title">Cumulative Profit</h2>
            <canvas id="profitChart" class="chart-canvas"></canvas>
        </div>

        <!-- Win/Loss Distribution -->
        <div class="distribution-section">
            <div class="pie-chart-container">
                <h3 class="section-title" style="font-size: 16px;">Trade Distribution</h3>
                <canvas id="pieChart"></canvas>
            </div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--success);"></div>
                    <span class="legend-label">Profitable Trades</span>
                    <span class="legend-value" id="winCount">0</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--danger);"></div>
                    <span class="legend-label">Losing Trades</span>
                    <span class="legend-value" id="lossCount">0</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--warning);"></div>
                    <span class="legend-label">Breakeven</span>
                    <span class="legend-value" id="breakevenCount">0</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--accent-primary);"></div>
                    <span class="legend-label">Closed by TP</span>
                    <span class="legend-value" id="tpCount">0</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--danger);"></div>
                    <span class="legend-label">Closed by SL</span>
                    <span class="legend-value" id="slCount">0</span>
                </div>
            </div>
        </div>

        <!-- Trades Table -->
        <div class="table-section">
            <div class="table-controls">
                <h2 class="section-title">Trade Details</h2>
                <div class="search-box">
                    <span class="search-icon">🔍</span>
                    <input type="text" id="searchInput" class="search-input" placeholder="Search trades...">
                </div>
                <button class="export-btn" onclick="exportToCSV()">Export CSV</button>
            </div>
            
            <div class="table-container">
                <table class="trades-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Date/Time</th>
                            <th>Symbol</th>
                            <th>Type</th>
                            <th>Volume</th>
                            <th>Entry Price</th>
                            <th>Exit Price</th>
                            <th>Exit Type</th>
                            <th>Profit</th>
                            <th>Commission</th>
                            <th>Swap</th>
                            <th>Net P/L</th>
                            <th>Duration</th>
                        </tr>
                    </thead>
                    <tbody id="tradesTableBody">
                        <!-- Trades will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <div class="pagination" id="pagination">
                <!-- Pagination buttons will be generated here -->
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loader"></div>
    </div>

    <script>
        // Global variables
        let ws = null;
        let tradesData = [];
        let filteredTrades = [];
        let currentPage = 1;
        const tradesPerPage = 20;
        let profitChartInstance = null;
        let pieChartInstance = null;

        // Initialize WebSocket connection
        function initWebSocket() {
            ws = new WebSocket('ws://127.0.0.1:8080');
            
            ws.onopen = () => {
                console.log('Connected to WebSocket');
                // Request initial data
                ws.send(JSON.stringify({
                    type: 'request',
                    data: 'initial'
                }));
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleServerMessage(data);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
            
            ws.onclose = () => {
                console.log('Disconnected from server');
                setTimeout(initWebSocket, 5000);
            };
        }

        // Handle messages from server
        function handleServerMessage(data) {
            switch(data.type) {
                case 'history':
                    hideLoading();
                    processHistoryData(data.trades);
                    break;
                case 'error':
                    hideLoading();
                    alert('Error: ' + data.message);
                    break;
            }
        }

        // Process history data
        function processHistoryData(trades) {
            tradesData = trades || [];
            filteredTrades = [...tradesData];
            
            calculateStatistics();
            renderTradesTable();
            drawProfitChart();
            drawPieChart();
            
            // Animation for numbers
            animateNumbers();
        }

        // Calculate statistics
        function calculateStatistics() {
            if (tradesData.length === 0) {
                resetStatistics();
                return;
            }
            
            const wins = tradesData.filter(t => t.profit > 0);
            const losses = tradesData.filter(t => t.profit < 0);
            const breakeven = tradesData.filter(t => t.profit === 0);
            
            // Exit types count
            const tpExits = tradesData.filter(t => t.comment && t.comment.includes('[tp]'));
            const slExits = tradesData.filter(t => t.comment && t.comment.includes('[sl]'));
            
            const totalProfit = tradesData.reduce((sum, t) => sum + t.profit, 0);
            const totalCommission = tradesData.reduce((sum, t) => sum + (t.commission || 0), 0);
            const totalSwap = tradesData.reduce((sum, t) => sum + (t.swap || 0), 0);
            const netProfit = totalProfit - totalCommission + totalSwap;
            
            const winRate = tradesData.length > 0 ? (wins.length / tradesData.length * 100) : 0;
            
            const avgWin = wins.length > 0 ? wins.reduce((sum, t) => sum + t.profit, 0) / wins.length : 0;
            const avgLoss = losses.length > 0 ? Math.abs(losses.reduce((sum, t) => sum + t.profit, 0) / losses.length) : 0;
            
            const grossProfit = wins.reduce((sum, t) => sum + t.profit, 0);
            const grossLoss = Math.abs(losses.reduce((sum, t) => sum + t.profit, 0));
            const profitFactor = grossLoss > 0 ? grossProfit / grossLoss : grossProfit > 0 ? 999 : 0;
            
            const bestTrade = Math.max(...tradesData.map(t => t.profit), 0);
            const worstTrade = Math.min(...tradesData.map(t => t.profit), 0);
            
            // Update UI
            document.getElementById('totalTrades').textContent = tradesData.length;
            document.getElementById('winRate').textContent = winRate.toFixed(1) + '%';
            
            const netProfitEl = document.getElementById('netProfit');
            netProfitEl.textContent = `$${Math.abs(netProfit).toFixed(2)}`;
            netProfitEl.className = netProfit >= 0 ? 'stat-value positive animated-number' : 'stat-value negative animated-number';
            if (netProfit < 0) netProfitEl.textContent = '-' + netProfitEl.textContent;
            
            document.getElementById('avgWin').textContent = `$${avgWin.toFixed(2)}`;
            document.getElementById('avgLoss').textContent = `-$${avgLoss.toFixed(2)}`;
            document.getElementById('profitFactor').textContent = profitFactor > 100 ? '∞' : profitFactor.toFixed(2);
            document.getElementById('bestTrade').textContent = `$${bestTrade.toFixed(2)}`;
            document.getElementById('worstTrade').textContent = `-$${Math.abs(worstTrade).toFixed(2)}`;
            
            // Update distribution counts
            document.getElementById('winCount').textContent = wins.length;
            document.getElementById('lossCount').textContent = losses.length;
            document.getElementById('breakevenCount').textContent = breakeven.length;
            document.getElementById('tpCount').textContent = tpExits.length;
            document.getElementById('slCount').textContent = slExits.length;
            
            // Update trend indicators
            document.getElementById('winRateTrend').textContent = winRate >= 50 ? ' Above 50%' : ' Below 50%';
            document.getElementById('profitTrend').textContent = netProfit >= 0 ? ' Profitable' : ' In Loss';
            document.getElementById('profitFactorStatus').textContent = profitFactor >= 1.5 ? ' Excellent' : profitFactor >= 1 ? ' Good' : '❌ Poor';
        }

        // Reset statistics
        function resetStatistics() {
            const elements = ['totalTrades', 'winRate', 'netProfit', 'avgWin', 'avgLoss', 'profitFactor', 'bestTrade', 'worstTrade'];
            elements.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = id === 'winRate' ? '0%' : '$0.00';
            });
        }

        // Render trades table
        function renderTradesTable() {
    const tbody = document.getElementById('tradesTableBody');
    const startIndex = (currentPage - 1) * tradesPerPage;
    const endIndex = startIndex + tradesPerPage;
    const pageTrades = filteredTrades.slice(startIndex, endIndex);
    
    if (pageTrades.length === 0) {
        tbody.innerHTML = '<tr><td colspan="13" style="text-align: center; padding: 40px; color: var(--text-secondary);">No trades found</td></tr>';
        return;
    }
    
    tbody.innerHTML = pageTrades.map(trade => {
        const net = trade.profit - (trade.commission || 0) + (trade.swap || 0);
        const profitClass = trade.profit >= 0 ? 'positive' : 'negative';
        const netClass = net >= 0 ? 'positive' : 'negative';
        
        // Используем exit_type из сервера
        let exitType = trade.exit_type || 'manual';
        let exitClass = exitType.toLowerCase();
        
        // Форматируем для отображения
        if (exitType === 'tp') {
            exitType = 'TP';
            exitClass = 'tp';
        } else if (exitType === 'sl') {
            exitType = 'SL';
            exitClass = 'sl';
        } else {
            exitType = 'Manual';
            exitClass = 'manual';
        }
        
        // Calculate duration
        const duration = trade.closeTime && trade.openTime ? 
            formatDuration(new Date(trade.closeTime) - new Date(trade.openTime)) : '-';
        
        return `
            <tr>
                <td class="trade-id">#${trade.id || trade.ticket}</td>
                <td>${new Date(trade.openTime).toLocaleString()}</td>
                <td><span class="symbol-badge">${trade.symbol}</span></td>
                <td><span class="trade-type ${trade.type}">${trade.type.toUpperCase()}</span></td>
                <td>${trade.volume.toFixed(2)}</td>
                <td>${formatPrice(trade.price || trade.openPrice)}</td>
                <td>${formatPrice(trade.closePrice || trade.price)}</td>
                <td><span class="exit-type ${exitClass}">${exitType}</span></td>
                <td class="profit-cell ${profitClass}">
                    ${trade.profit >= 0 ? '+' : ''}$${Math.abs(trade.profit).toFixed(2)}
                </td>
                <td>-$${Math.abs(trade.commission || 0).toFixed(2)}</td>
                <td>${trade.swap >= 0 ? '+' : '-'}$${Math.abs(trade.swap || 0).toFixed(2)}</td>
                <td class="profit-cell ${netClass}">
                    ${net >= 0 ? '+' : ''}$${Math.abs(net).toFixed(2)}
                </td>
                <td>${duration}</td>
            </tr>
        `;
    }).join('');
    
    renderPagination();
}

        // Render pagination
        function renderPagination() {
            const totalPages = Math.ceil(filteredTrades.length / tradesPerPage);
            const paginationEl = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                paginationEl.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // Previous button
            html += `<button class="page-btn" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>←</button>`;
            
            // Page numbers
            for (let i = 1; i <= Math.min(totalPages, 5); i++) {
                if (i === currentPage) {
                    html += `<button class="page-btn active">${i}</button>`;
                } else {
                    html += `<button class="page-btn" onclick="changePage(${i})">${i}</button>`;
                }
            }
            
            if (totalPages > 5) {
                html += `<span style="color: var(--text-secondary);">...</span>`;
                html += `<button class="page-btn" onclick="changePage(${totalPages})">${totalPages}</button>`;
            }
            
            // Next button
            html += `<button class="page-btn" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>→</button>`;
            
            paginationEl.innerHTML = html;
        }

        // Change page
        function changePage(page) {
            const totalPages = Math.ceil(filteredTrades.length / tradesPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            renderTradesTable();
            window.scrollTo({ top: document.querySelector('.table-section').offsetTop - 100, behavior: 'smooth' });
        }

        // Draw profit chart
        function drawProfitChart() {
            const canvas = document.getElementById('profitChart');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = canvas.offsetWidth;
            canvas.height = 300;
            
            if (tradesData.length === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'var(--text-secondary)';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No data to display', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // Calculate cumulative profit
            let cumulative = 0;
            const profitData = [0];
            tradesData.forEach(trade => {
                cumulative += trade.profit - (trade.commission || 0) + (trade.swap || 0);
                profitData.push(cumulative);
            });
            
            const maxProfit = Math.max(...profitData);
            const minProfit = Math.min(...profitData);
            const range = maxProfit - minProfit || 100;
            
            const padding = 50;
            const width = canvas.width - padding * 2;
            const height = canvas.height - padding * 2;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw grid
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            
            for (let i = 0; i <= 5; i++) {
                const y = padding + (height * i / 5);
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();
                
                // Y-axis labels
                const value = maxProfit - (range * i / 5);
                ctx.fillStyle = 'var(--text-secondary)';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(`$${value.toFixed(0)}`, padding - 10, y + 4);
            }
            
            // Draw zero line
            if (minProfit < 0 && maxProfit > 0) {
                const zeroY = padding + height * (maxProfit / range);
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(padding, zeroY);
                ctx.lineTo(canvas.width - padding, zeroY);
                ctx.stroke();
                ctx.setLineDash([]);
            }
            
            // Draw profit line
            const stepX = width / (profitData.length - 1);
            
            // Create gradient
            const gradient = ctx.createLinearGradient(0, padding, 0, canvas.height - padding);
            gradient.addColorStop(0, cumulative >= 0 ? 'var(--success)' : 'var(--danger)');
            gradient.addColorStop(1, cumulative >= 0 ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)');
            
            // Draw area
            ctx.fillStyle = gradient;
            ctx.beginPath();
            profitData.forEach((profit, i) => {
                const x = padding + i * stepX;
                const y = padding + height * ((maxProfit - profit) / range);
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.lineTo(padding + (profitData.length - 1) * stepX, canvas.height - padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.closePath();
            ctx.fill();
            
            // Draw line
            ctx.strokeStyle = cumulative >= 0 ? 'var(--success)' : 'var(--danger)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            profitData.forEach((profit, i) => {
                const x = padding + i * stepX;
                const y = padding + height * ((maxProfit - profit) / range);
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();
            
            // Draw dots
            profitData.forEach((profit, i) => {
                if (i % Math.ceil(profitData.length / 20) === 0) {
                    const x = padding + i * stepX;
                    const y = padding + height * ((maxProfit - profit) / range);
                    
                    ctx.fillStyle = cumulative >= 0 ? 'var(--success)' : 'var(--danger)';
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, Math.PI * 2);
                    ctx.fill();
                }
            });
        }

        // Draw pie chart
        function drawPieChart() {
            const canvas = document.getElementById('pieChart');
            const ctx = canvas.getContext('2d');
            
            canvas.width = 200;
            canvas.height = 200;
            
            const wins = tradesData.filter(t => t.profit > 0).length;
            const losses = tradesData.filter(t => t.profit < 0).length;
            const breakeven = tradesData.filter(t => t.profit === 0).length;
            
            const total = wins + losses + breakeven;
            
            if (total === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                return;
            }
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 80;
            
            let currentAngle = -Math.PI / 2;
            
            const segments = [
                { value: wins, color: 'var(--success)' },
                { value: losses, color: 'var(--danger)' },
                { value: breakeven, color: 'var(--warning)' }
            ];
            
            segments.forEach(segment => {
                if (segment.value === 0) return;
                
                const angle = (segment.value / total) * Math.PI * 2;
                
                ctx.fillStyle = segment.color;
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + angle);
                ctx.lineTo(centerX, centerY);
                ctx.closePath();
                ctx.fill();
                
                // Draw border
                ctx.strokeStyle = 'var(--bg-primary)';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                currentAngle += angle;
            });
            
            // Draw center hole
            ctx.fillStyle = 'var(--bg-panel)';
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius * 0.6, 0, Math.PI * 2);
            ctx.fill();
            
            // Draw win rate in center
            const winRate = total > 0 ? (wins / total * 100).toFixed(0) : 0;
            ctx.fillStyle = 'var(--text-primary)';
            ctx.font = 'bold 24px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(winRate + '%', centerX, centerY);
        }

        // Load history
        function loadHistory() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('Not connected to server');
                return;
            }
            
            showLoading();
            
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            ws.send(JSON.stringify({
                type: 'history',
                from: dateFrom,
                to: dateTo
            }));
        }

        // Set quick period
        function setPeriod(period) {
            const today = new Date();
            let fromDate = new Date();
            let toDate = new Date();
            
            switch(period) {
                case 'today':
                    fromDate = new Date(today.setHours(0, 0, 0, 0));
                    break;
               case 'yesterday':
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    yesterday.setHours(0, 0, 0, 0);
    fromDate = new Date(yesterday);
    
    toDate = new Date(yesterday);
    toDate.setHours(23, 59, 59, 999);
    break;
                case 'week':
                    fromDate = new Date(today.setDate(today.getDate() - 7));
                    break;
                case 'month':
                    fromDate = new Date(today.setMonth(today.getMonth() - 1));
                    break;
                case '3months':
                    fromDate = new Date(today.setMonth(today.getMonth() - 3));
                    break;
                case 'year':
                    fromDate = new Date(today.getFullYear(), 0, 1);
                    break;
                case 'all':
                    fromDate = new Date('2020-01-01');
                    break;
            }
            
            document.getElementById('dateFrom').value = fromDate.toISOString().split('T')[0];
            document.getElementById('dateTo').value = toDate.toISOString().split('T')[0];
            
            loadHistory();
        }

        // Search functionality
        document.getElementById('searchInput')?.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            
            if (searchTerm === '') {
                filteredTrades = [...tradesData];
            } else {
                filteredTrades = tradesData.filter(trade => 
                    trade.symbol.toLowerCase().includes(searchTerm) ||
                    trade.type.toLowerCase().includes(searchTerm) ||
                    (trade.comment && trade.comment.toLowerCase().includes(searchTerm))
                );
            }
            
            currentPage = 1;
            renderTradesTable();
        });

        // Export to CSV
        function exportToCSV() {
            if (tradesData.length === 0) {
                alert('No data to export');
                return;
            }
            
            let csv = 'ID,Date,Symbol,Type,Volume,Entry,Exit,Profit,Commission,Swap,Net\n';
            
            tradesData.forEach(trade => {
                const net = trade.profit - (trade.commission || 0) + (trade.swap || 0);
                csv += `${trade.id || trade.ticket},`;
                csv += `${new Date(trade.openTime).toLocaleString()},`;
                csv += `${trade.symbol},`;
                csv += `${trade.type},`;
                csv += `${trade.volume},`;
                csv += `${trade.price || trade.openPrice},`;
                csv += `${trade.closePrice || trade.price},`;
                csv += `${trade.profit},`;
                csv += `${trade.commission || 0},`;
                csv += `${trade.swap || 0},`;
                csv += `${net}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trading_history_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // Format price
        function formatPrice(price) {
            if (!price && price !== 0) return '-';
            return price.toFixed(5);
        }

        // Format duration
        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) return `${days}d ${hours % 24}h`;
            if (hours > 0) return `${hours}h ${minutes % 60}m`;
            if (minutes > 0) return `${minutes}m`;
            return `${seconds}s`;
        }

        // Animate numbers
        function animateNumbers() {
            document.querySelectorAll('.animated-number').forEach(el => {
                el.style.animation = 'none';
                setTimeout(() => {
                    el.style.animation = '';
                }, 10);
            });
        }

        // Show/hide loading
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // Refresh data
        function refreshData() {
            loadHistory();
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            // Set default dates
            const today = new Date();
            const monthAgo = new Date();
            monthAgo.setMonth(monthAgo.getMonth() - 1);
            
            document.getElementById('dateTo').value = today.toISOString().split('T')[0];
            document.getElementById('dateFrom').value = monthAgo.toISOString().split('T')[0];
            
            // Initialize WebSocket
            initWebSocket();
            
            // Load initial data after connection
            setTimeout(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    loadHistory();
                }
            }, 1000);
        });
    </script>
</body>
</html>